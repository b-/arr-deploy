---
secrets:
  bri_password:
    environment: bri_password
  ts_authkey:
    environment: TS_AUTHKEY
configs:
  filebrowser.yml:
    content: |
      server:
        database: /tmp/filebrowser.db
        sources:
          - path: /var/srv
            name: /var/srv
      auth:
        key: "${FILEBROWSER_PASSWORD_HASH}"
        adminUsername: admin
        adminPassword: "${FILEBROWSER_PASSWORD}"
  samba_config.yml:
    content: |
      auth:
        - user: bri
          group: bri
          uid: 1000
          gid: 1000
          password_file: /run/secrets/bri_password
      global:
        - "force user = bri"
        - "force group = bri"
        - "acl allow execute always = yes"
      share:
        - name: host
          path: /host
          browsable: yes
          readonly: no
          guestok: no
          validusers: bri
          writelist: bri
          veto: no
          #hidefiles: /_*/
  filebrowser_serve:
    content: |
      {
        "TCP": {
          "443": {
            "HTTPS": true
          }
        },
        "Web": {
          "$${TS_CERT_DOMAIN}:443": {
            "Handlers": {
              "/": {
                "Proxy": "http://localhost:79"
              }
            }
          }
        },
        "AllowFunnel": {
          "$${TS_CERT_DOMAIN}:443": false
        },
        "Services": {
          "svc:arr-filebrowser": {
            "TCP": {
              "443": {
                "HTTPS": true
              }
            },
            "Web": {
              "$${TS_CERT_DOMAIN}:443": {
                "Handlers": {
                  "/": {
                    "Proxy": "https+insecure://126.0.0.1:8006"
                  }
                }
              }
            }
          }
        }
      }

  jellyfin_serve:
    content: |
      {
          "TCP": {
              "443": {
                  "HTTPS": true
              }
          },
          "Web": {
              "$${TS_CERT_DOMAIN}:443": {
                  "Handlers": {
                      "/": {
                          "Proxy": "http://localhost:8096"
                      }
                  }
              }
          },
          "AllowFunnel": {
              "$${TS_CERT_DOMAIN}:443": true
          },
          "Services": {
              "svc:jellyfin": {
                  "TCP": {
                      "443": {
                          "HTTPS": true
                      }
                  },
                  "Web": {
                      "$${TS_CERT_DOMAIN}:443": {
                          "Handlers": {
                              "/": {
                                  "Proxy": "http://localhost:32400"
                              }
                          }
                      }
                  }
              }
          }
      }

  plex_serve:
    content: |
      {
          "TCP": {
              "443": {
                  "HTTPS": true
              }
          },
          "Web": {
              "$${TS_CERT_DOMAIN}:443": {
                  "Handlers": {
                      "/": {
                          "Proxy": "http://localhost:32400"
                      }
                  }
              }
          },
          "AllowFunnel": {
              "$${TS_CERT_DOMAIN}:443": true
          },
          "Services": {
              "svc:plex": {
                  "TCP": {
                      "443": {
                          "HTTPS": true
                      }
                  },
                  "Web": {
                      "$${TS_CERT_DOMAIN}:443": {
                          "Handlers": {
                              "/": {
                                  "Proxy": "http://localhost:32400"
                              }
                          }
                      }
                  }
              }
          }
      }

  prowlarr_serve:
    content: |
      {
          "TCP": {
              "443": {
                  "HTTPS": true
              }
          },
          "Web": {
              "$${TS_CERT_DOMAIN}:443": {
                  "Handlers": {
                      "/": {
                          "Proxy": "http://localhost:9696"
                      }
                  }
              }
          },
          "AllowFunnel": {
              "$${TS_CERT_DOMAIN}:443": false
          },
          "Services": {
              "svc:prowlarr": {
                  "TCP": {
                      "443": {
                          "HTTPS": true
                      }
                  },
                  "Web": {
                      "$${TS_CERT_DOMAIN}:443": {
                          "Handlers": {
                              "/": {
                                  "Proxy": "http://localhost:9696"
                              }
                          }
                      }
                  }
              }
          }
      }

  radarr_serve:
    content: |
      {
          "TCP": {
              "443": {
                  "HTTPS": true
              }
          },
          "Web": {
              "$${TS_CERT_DOMAIN}:443": {
                  "Handlers": {
                      "/": {
                          "Proxy": "http://localhost:7878"
                      }
                  }
              }
          },
          "AllowFunnel": {
              "$${TS_CERT_DOMAIN}:443": false
          },
          "Services": {
              "svc:radarr": {
                  "TCP": {
                      "443": {
                          "HTTPS": true
                      }
                  },
                  "Web": {
                      "$${TS_CERT_DOMAIN}:443": {
                          "Handlers": {
                              "/": {
                                  "Proxy": "http://localhost:7878"
                              }
                          }
                      }
                  }
              }
          }
      }

  sonarr_serve:
    content: |
      {
          "TCP": {
              "443": {
                  "HTTPS": true
              }
          },
          "Web": {
              "$${TS_CERT_DOMAIN}:443": {
                  "Handlers": {
                      "/": {
                          "Proxy": "http://localhost:8989"
                      }
                  }
              }
          },
          "AllowFunnel": {
              "$${TS_CERT_DOMAIN}:443": false
          },
          "Services": {
              "svc:sonarr": {
                  "TCP": {
                      "443": {
                          "HTTPS": true
                      }
                  },
                  "Web": {
                      "$${TS_CERT_DOMAIN}:443": {
                          "Handlers": {
                              "/": {
                                  "Proxy": "http://localhost:8989"
                              }
                          }
                      }
                  }
              }
          }
      }

  lidarr_serve:
    content: |
      {
          "TCP": {
              "443": {
                  "HTTPS": true
              }
          },
          "Web": {
              "$${TS_CERT_DOMAIN}:443": {
                  "Handlers": {
                      "/": {
                          "Proxy": "http://localhost:8686"
                      }
                  }
              }
          },
          "AllowFunnel": {
              "$${TS_CERT_DOMAIN}:443": false
          },
          "Services": {
              "svc:lidarr": {
                  "TCP": {
                      "443": {
                          "HTTPS": true
                      }
                  },
                  "Web": {
                      "$${TS_CERT_DOMAIN}:443": {
                          "Handlers": {
                              "/": {
                                  "Proxy": "http://localhost:8686"
                              }
                          }
                      }
                  }
              }
          }
      }

  whoami_serve:
    content: |
      {
          "TCP": {
              "443": {
                  "HTTPS": true
              }
          },
          "Web": {
              "$${TS_CERT_DOMAIN}:443": {
                  "Handlers": {
                      "/": {
                          "Proxy": "http://localhost:80"
                      }
                  }
              }
          },
          "AllowFunnel": {
              "$${TS_CERT_DOMAIN}:443": true
          },
          "Services": {
              "svc:whoami": {
                  "TCP": {
                      "443": {
                          "HTTPS": true
                      }
                  },
                  "Web": {
                      "$${TS_CERT_DOMAIN}:443": {
                          "Handlers": {
                              "/": {
                                  "Proxy": "http://localhost:80"
                              }
                          }
                      }
                  }
              }
          }
      }
  qb_serve:
    content: |
      {
          "TCP": {
              "443": {
                  "HTTPS": true
              }
          },
          "Web": {
              "$${TS_CERT_DOMAIN}:443": {
                  "Handlers": {
                      "/": {
                          "Proxy": "http://localhost:8112"
                      }
                  }
              }
          },
          "AllowFunnel": {
              "$${TS_CERT_DOMAIN}:443": false
          },
          "Services": {
              "svc:qbittorrent": {
                  "TCP": {
                      "443": {
                          "HTTPS": true
                      }
                  },
                  "Web": {
                      "qbittorrent.shark-perch.ts.net:443": {
                          "Handlers": {
                              "/": {
                                  "Proxy": "http://localhost:8112"
                              }
                          }
                      }
                  }
              }
          }
      }
  tautulli_serve:
    content: |
      {
          "TCP": {
              "443": {
                  "HTTPS": true
              }
          },
          "Web": {
              "$${TS_CERT_DOMAIN}:443": {
                  "Handlers": {
                      "/": {
                          "Proxy": "http://localhost:8181"
                      }
                  }
              }
          },
          "AllowFunnel": {
              "$${TS_CERT_DOMAIN}:443": false
          },
          "Services": {
              "svc:tautulli": {
                  "TCP": {
                      "443": {
                          "HTTPS": true
                      }
                  },
                  "Web": {
                      "$${TS_CERT_DOMAIN}:443": {
                          "Handlers": {
                              "/": {
                                  "Proxy": "http://localhost:8181"
                              }
                          }
                      }
                  }
              }
          }
      }

  syncthing_serve:
    content: |
      {
          "TCP": {
              "443": {
                  "HTTPS": true
              }
          },
          "Web": {
              "$${TS_CERT_DOMAIN}:443": {
                  "Handlers": {
                      "/": {
                          "Proxy": "http://localhost:8384"
                      }
                  }
              }
          },
          "AllowFunnel": {
              "$${TS_CERT_DOMAIN}:443": false
          },
          "Services": {
              "svc:syncthing": {
                  "TCP": {
                      "443": {
                          "HTTPS": true
                      }
                  },
                  "Web": {
                      "$${TS_CERT_DOMAIN}:443": {
                          "Handlers": {
                              "/": {
                                  "Proxy": "http://localhost:8384"
                              }
                          }
                      }
                  }
              }
          }
      }

  jellyseerr_serve:
    content: |
      {
          "TCP": {
              "443": {
                  "HTTPS": true
              }
          },
          "Web": {
              "$${TS_CERT_DOMAIN}:443": {
                  "Handlers": {
                      "/": {
                          "Proxy": "http://localhost:5055"
                      }
                  }
              }
          },
          "AllowFunnel": {
              "$${TS_CERT_DOMAIN}:443": false
          },
          "Services": {
              "svc:jellyseerr": {
                  "TCP": {
                      "443": {
                          "HTTPS": true
                      }
                  },
                  "Web": {
                      "$${TS_CERT_DOMAIN}:443": {
                          "Handlers": {
                              "/": {
                                  "Proxy": "http://localhost:5055"
                              }
                          }
                      }
                  }
              }
          }
      }

x-ts-sidecar: &ts-sidecar
  # volumes:
  #   - ts_state:/ts_state
  image: tailscale/tailscale:latest
  environment: &ts-env
    TS_AUTHKEY: ${TS_AUTHKEY}
    TS_EXTRA_ARGS: "--advertise-tags=tag:docker"
    #TS_USERSPACE: false
    TS_ENABLE_HEALTH_CHECK: true
    TS_LOCAL_ADDR_PORT: 127.0.0.1:41234
    TS_STATE: "mem:"
    #TS_SERVE_CONFIG: /config/serve.json
    #TS_AUTHKEY: tskey-auth-kS5WUC4XYe11CNTRL-AT7DucG3DnhrX8j6rmPdhhcuN2mRerBk
    #TS_HOSTNAME: generic-sidecar
  #    ports:
  #      - "8120"
  #    devices:
  #      - /dev/net/tun:/dev/net/tun # Network configuration for Tailscale to work
  #    cap_add:
  #      - net_admin # Tailscale requirement
  #      - sys_module # Tailscale requirement
  healthcheck:
    test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:41234/healthz"] # Check Tailscale has a Tailnet IP and is operational
    interval: 1m # How often to perform the check
    timeout: 10s # Time to wait for the check to succeed
    retries: 3 # Number of retries before marking as unhealthy
    start_period: 10s # Time to wait before starting health checks
  restart: always
  
networks:
  default:
    name: arr
services:
  filebrowser-ts:
    <<: *ts-sidecar
    environment:
      <<: *ts-env
      TS_HOSTNAME: "filebrowser-arr"
      TS_SERVE_CONFIG: /config/ts_serve.json
    configs:
      - source: filebrowser_serve
        target: /config/ts_serve.json
    extra_hosts:
      - host.docker.internal=host-gateway
    labels:
      - traefik.enable=true
      - "traefik.http.routers.filebrowser.rule=HostRegexp(`^filebrowser${TRAEFIK_RULE_SUFFIX}"
      - traefik.http.services.filebrowser.loadbalancer.server.port=80
      - "kop.filebrowser.bind.ip=filebrowser-arr.shark-perch.ts.net"
#    ports:
#      - 80:80
# filebrowser
  filebrowser:
    configs:
      - filebrowser.yml
    #ports: !reset [null]
    ports: !reset null
    user: !reset [null]
    network_mode: service:filebrowser-ts
    command: [ "-c", "/filebrowser.yml"]
    volumes: !override
      - type: bind
        source: /var/srv
        target: /var/srv
        bind:
          create_host_path: false
      #- type: bind
      #  source: /var/srv/filebrowser/filebrowser.db
      #  target: /database.db
      #  bind:
      #    create_host_path: false
      #  selinux: Z
      #- type: bind
      #  source: /var/srv/apps/filebrowser/config
      #  target: /config
      #  bind:
      #    create_host_path: true

# jellyfin
  jellyfin-ts:
    <<: *ts-sidecar
    environment:
      <<: *ts-env
      TS_HOSTNAME: "jellyfin-arr"
      TS_LOCAL_ADDR_PORT: 127.0.0.1:41236
      TS_SERVE_CONFIG: /config/ts_serve.json
    configs:
      - source: jellyfin_serve
        target: /config/ts_serve.json
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:41236/healthz"] # Check Tailscale has a Tailnet IP and is operational
    extra_hosts:
      - host.docker.internal=host-gateway
    labels:
      - "traefik.enable=true"
      #- "traefik.docker.network=traefik"
      - "traefik.http.routers.jellyfin.rule=HostRegexp(`^jellyfin${TRAEFIK_RULE_SUFFIX}"
      - traefik.http.services.jellyfin.loadbalancer.server.port=8096
      - "kop.jellyfin.bind.ip=jellyfin-arr.shark-perch.ts.net"
    ports:
      - 8096:8096
      - 8920:8920 #optional
      - 7359:7359/udp #optional
      - 1900:1900/udp #optional
  jellyfin:
    network_mode: service:jellyfin-ts
    ports: !reset [null]
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - JELLYFIN_PublishedServerUrl=https://jellyfin.${TRAEFIK_FQDN}
    volumes:
      # - type: bind
      #   source: /var/srv/media
      #   target: /media
      #   bind:
      #     create_host_path: false
      - type: bind
        source: /var/srv/media/content/tv
        target: /data/tvshows
        bind:
          create_host_path: false
      - type: bind
        source: /var/srv/media/content/movies
        target: /data/movies
        bind:
          create_host_path: false
      - type: bind
        source: /var/srv/apps/jellyfin/data
        target: /config
        bind:
          create_host_path: true
    restart: unless-stopped


# plex
  plex-ts:
    <<: *ts-sidecar
    network_mode: host
    environment:
      <<: *ts-env
      TS_HOSTNAME: "plex-arr"
      TS_LOCAL_ADDR_PORT: 127.0.0.1:41235
      TS_SERVE_CONFIG: /config/ts_serve.json
    configs:
      - source: plex_serve
        target: /config/ts_serve.json
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:41235/healthz"] # Check Tailscale has a Tailnet IP and is operational
    extra_hosts:
      - host.docker.internal=host-gateway
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.plex.rule=HostRegexp(`^plex${TRAEFIK_RULE_SUFFIX}"
      - traefik.http.services.plex.loadbalancer.server.port=32400
      - "kop.plex.bind.ip=plex-arr.shark-perch.ts.net"
  plex:
    network_mode: service:plex-ts
    ports: !reset [null]
    environment:
      - TZ=${TZ}
      - VERSION=latest
    volumes:
      - type: bind
        source: /var/srv/media
        target: /media
        bind:
          create_host_path: false
      # - type: bind
      #   source: /var/srv/media/content/tv
      #   target: /tv
      #   bind:
      #     create_host_path: false
      # - type: bind
      #   source: /var/srv/media/content/movies
      #   target: /movies
      #   bind:
      #     create_host_path: false
      - type: bind
        source: /var/srv/apps/plex/data
        target: /config
        bind:
          create_host_path: true

    restart: unless-stopped

# Arr stack
  prowlarr-ts:
    <<: *ts-sidecar
    environment:
      <<: *ts-env
      TS_HOSTNAME: "prowlarr-arr"
      TS_SERVE_CONFIG: /config/ts_serve.json
    configs:
      - source: prowlarr_serve
        target: /config/ts_serve.json
    extra_hosts:
      - host.docker.internal=host-gateway
    labels:
      - "traefik.enable=true"
      #- "traefik.docker.network=traefik"
      - "traefik.http.routers.prowlarr.rule=HostRegexp(`^prowlarr${TRAEFIK_RULE_SUFFIX}"
      - "kop.prowlarr.bind.ip=prowlarr-arr.shark-perch.ts.net"
      - "traefik.http.services.prowlarr.loadbalancer.server.port=9696"
  prowlarr:
    ports: !reset [null]
    network_mode: service:prowlarr-ts
    environment:
      - TZ=${TZ}
    volumes:
      - type: bind
        source: /var/srv/apps/prowlarr/data
        target: /config
        bind:
          create_host_path: true
  radarr-ts:
    <<: *ts-sidecar
    environment:
      <<: *ts-env
      TS_HOSTNAME: "radarr-arr"
      TS_SERVE_CONFIG: /config/ts_serve.json
    configs:
      - source: radarr_serve
        target: /config/ts_serve.json
    extra_hosts:
      - host.docker.internal=host-gateway
    labels:
      - "traefik.enable=true"
      #- "traefik.docker.network=${TRAEFIK_DOCKER_NETWORK}"
      - "traefik.http.routers.radarr.rule=HostRegexp(`^radarr${TRAEFIK_RULE_SUFFIX}"
      - "traefik.http.services.radarr.loadbalancer.server.port=7878"
      - "kop.radarr.bind.ip=radarr-arr.shark-perch.ts.net"
  radarr:
    network_mode: service:radarr-ts
    ports: !reset [null]
    environment:
      - TZ=${TZ}
    volumes: !override
      - type: bind
        source: /var/srv/media
        target: /media
        bind:
          create_host_path: false
      - type: bind
        source: /var/srv/apps/radarr/data
        target: /config
        bind:
          create_host_path: true
      # - type: bind
      #   source: /var/srv/media/content/movies
      #   target: /movies
      #   bind:
      #     create_host_path: false
      # - type: bind
      #   source: /var/srv/media/downloads
      #   target: /downloads
      #   bind:
      #     create_host_path: false
  sonarr-ts:
    <<: *ts-sidecar
    environment:
      <<: *ts-env
      TS_HOSTNAME: "sonarr-arr"
      TS_SERVE_CONFIG: /config/ts_serve.json
    configs:
      - source: sonarr_serve
        target: /config/ts_serve.json
    labels:
      - "traefik.enable=true"
      #- "traefik.docker.network=traefik"
      - "traefik.http.routers.sonarr.rule=HostRegexp(`^sonarr${TRAEFIK_RULE_SUFFIX}"
      - "traefik.http.services.sonarr.loadbalancer.server.port=8989"
      - "kop.sonarr.bind.ip=sonarr-arr.shark-perch.ts.net"
    extra_hosts:
      - host.docker.internal=host-gateway
  sonarr:
    ports: !reset [null]
    network_mode: service:sonarr-ts
    environment:
      - TZ=${TZ}
    volumes: !override
      - type: bind
        source: /var/srv/media
        target: /media
        bind:
          create_host_path: false
      - type: bind
        source: /var/srv/apps/sonarr/data
        target: /config
        bind:
          create_host_path: true

  lidarr-ts:
    <<: *ts-sidecar
    environment:
      <<: *ts-env
      TS_HOSTNAME: "lidarr-arr"
      TS_SERVE_CONFIG: /config/ts_serve.json
    configs:
      - source: lidarr_serve
        target: /config/ts_serve.json
    extra_hosts:
      - host.docker.internal=host-gateway
    labels:
      - "traefik.enable=true"
      #- "traefik.docker.network=${TRAEFIK_DOCKER_NETWORK}"
      - "traefik.http.routers.lidarr.rule=HostRegexp(`^lidarr${TRAEFIK_RULE_SUFFIX}"
      - "traefik.http.services.lidarr.loadbalancer.server.port=8686"
      - "kop.lidarr.bind.ip=lidarr-arr.shark-perch.ts.net"
  lidarr:
    image: docker.io/blampe/lidarr:latest
    network_mode: service:lidarr-ts
    ports: !reset [null]
    environment:
      - TZ=${TZ}
    volumes: !override
      - type: bind
        source: /var/srv/media
        target: /media
        bind:
          create_host_path: false
      - type: bind
        source: /var/srv/apps/lidarr/data
        target: /config
        bind:
          create_host_path: true
      # - type: bind
      #   source: /var/srv/media/content/movies
      #   target: /movies
      #   bind:
      #     create_host_path: false
      # - type: bind
      #   source: /var/srv/media/downloads
      #   target: /downloads
      #   bind:
      #     create_host_path: false


# tautulli
  tautulli-ts:
    <<: *ts-sidecar
    ports:
      - 8181:8181
    environment:
      <<: *ts-env
      TS_HOSTNAME: "tautulli-arr"
      TS_SERVE_CONFIG: /config/ts_serve.json
    configs:
      - source: tautulli_serve
        target: /config/ts_serve.json
    extra_hosts:
      - host.docker.internal=host-gateway
    labels:
      - "traefik.enable=true"
      #- "traefik.docker.network=traefik"
      - "traefik.http.routers.tautulli.rule=HostRegexp(`^tautulli${TRAEFIK_RULE_SUFFIX}"
      - "traefik.http.services.tautulli.loadbalancer.server.port=8181"
      - "kop.tautulli.bind.ip=tautulli-arr.shark-perch.ts.net"
  tautulli:
    network_mode: service:tautulli-ts
    ports: !reset [null]
    environment:
      - TZ=America/New_York
    volumes: !override
      - type: bind
        source: /var/srv/apps/tautulli/data
        target: /config
        bind:
          create_host_path: true
  qbittorrent-ts:
    <<: *ts-sidecar
    network_mode: host
    environment:
      <<: *ts-env
      TS_HOSTNAME: "qb-mediaboxlite"
      TS_SERVE_CONFIG: /config/ts_serve.json
    configs:
      - source: qb_serve
        target: /config/ts_serve.json
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.qbittorrent.rule=HostRegexp(`^qbittorrent${TRAEFIK_RULE_SUFFIX}"
      - "traefik.http.services.qbittorrent.loadbalancer.server.port=8112"
      - "kop.qbittorrent.bind.ip=qb-mediaboxlite.shark-perch.ts.net"
  qbittorrent:
      ports: !reset [null]
      network_mode: service:qbittorrent-ts
      environment:
        - TZ=America/New_York
        - WEBUI_PORT=8112
        - TORRENTING_PORT=51412
        #- DOCKER_MODS=ghcr.io/vuetorrent/vuetorrent-lsio-mod:latest
      volumes: !override
        - type: bind
          source: /var/srv/apps/qbittorrent/appdata
          target: /config
          bind:
            create_host_path: true
        - type: bind
          source: /var/srv/media/downloads
          target: /downloads
          bind:
            create_host_path: true
        - type: bind
          source: /var/srv/media
          target: /media
          bind:
            create_host_path: true
      #network_mode: host
      restart: unless-stopped
# samba
  samba:
    secrets:
      - bri_password
    configs:
      - source: samba_config.yml
        target: /data/config.yml
    image: crazymax/samba
    container_name: samba
    network_mode: host
    volumes:
      - /:/host:Z
    environment:
      - "TZ=$TIMEZONE"
      - "WSDD2_ENABLE=1"
      - "SAMBA_HOSTS_ALLOW=127.0.0.0/8 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16 100.64.0.0/10"
      #- "SAMBA_LOG_LEVEL=0"
    restart: always


  syncthing-ts:
    <<: *ts-sidecar
    hostname: syncthing
    environment:
      <<: *ts-env
      TS_HOSTNAME: "syncthing-arr"
      TS_SERVE_CONFIG: /config/ts_serve.json
    configs:
      - source: syncthing_serve
        target: /config/ts_serve.json
    extra_hosts:
      - host.docker.internal=host-gateway
    ports:
      - 8384:8384
      - 22000:22000/tcp
      - 22000:22000/udp
      - 21027:21027/udp
    labels:
      - "traefik.enable=true"
      #- "traefik.docker.network=traefik"
      - "traefik.http.routers.syncthing.rule=HostRegexp(`^syncthing${TRAEFIK_RULE_SUFFIX}"
      - "kop.syncthing.bind.ip=syncthing-arr.shark-perch.ts.net"
      - "traefik.http.services.syncthing.loadbalancer.server.port=8384"
  syncthing:
    ports: !reset [null]
    hostname: !reset null
    network_mode: service:syncthing-ts
    environment:
      - TZ=${TZ}
    volumes: !override
      - type: bind
        source: /var/srv/media
        target: /media
        bind:
          create_host_path: false
      - type: bind
        source: /var/srv/apps/syncthing/data
        target: /config
        bind:
          create_host_path: true

  jellyseerr-ts:
    <<: *ts-sidecar
    hostname: jellyseerr
    environment:
      <<: *ts-env
      TS_HOSTNAME: "jellyseerr-arr"
      TS_SERVE_CONFIG: /config/ts_serve.json
    configs:
      - source: jellyseerr_serve
        target: /config/ts_serve.json
    extra_hosts:
      - host.docker.internal=host-gateway
    labels:
      - "traefik.enable=true"
      #- "traefik.docker.network=traefik"
      - "traefik.http.routers.jellyseerr.rule=HostRegexp(`^jellyseerr${TRAEFIK_RULE_SUFFIX}"
      - "kop.jellyseerr.bind.ip=jellyseerr-arr.shark-perch.ts.net"
      - "traefik.http.services.jellyseerr.loadbalancer.server.port=5055"
    ports:
      - 5055:5055
  jellyseerr:
    ports: !reset [null]
    hostname: !reset null
    network_mode: service:jellyseerr-ts
    environment:
      - TZ=${TZ}
    volumes: !override
      - type: bind
        source: /var/srv/media
        target: /media
        bind:
          create_host_path: false
      - type: bind
        source: /var/srv/apps/jellyseerr/data
        target: /app/config
        bind:
          create_host_path: true
